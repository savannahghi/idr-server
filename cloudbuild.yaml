steps:
  # Build the container image
  - id: "build image"
    name: "gcr.io/cloud-builders/docker"
    args:
      [
        "build",
        "-t",
        "${_IMAGE_NAME}:$COMMIT_SHA",
        ".",
      ]

  # Push the container image to Container Registry
  - id: "push image"
    name: "gcr.io/cloud-builders/docker"
    args:
      [
        "push",
        "${_IMAGE_NAME}:$COMMIT_SHA"
      ]

  # Apply the latest migrations
  - id: "apply migrations"
    name: "gcr.io/google-appengine/exec-wrapper"
    args:
      [
        "-i", "${_IMAGE_NAME}:$COMMIT_SHA",
        "-s", "${_CLOUDSQL_INSTANCE_CONNECTION_NAME}",
        "-e", "DJANGO_SETTINGS_MODULE=config.settings.production",
        "-e", "GOOGLE_CLOUD_PROJECT=$PROJECT_ID",
        "-e", "SETTINGS_NAME=${_SETTINGS_NAME}",
        "--", "python", "/app/manage.py", "migrate",
      ]

  # Create cache table
  - id: "create cache table"
    name: "gcr.io/google-appengine/exec-wrapper"
    args:
      [
        "-i", "${_IMAGE_NAME}:$COMMIT_SHA",
        "-s", "${_CLOUDSQL_INSTANCE_CONNECTION_NAME}",
        "-e", "DJANGO_SETTINGS_MODULE=config.settings.production",
        "-e", "GOOGLE_CLOUD_PROJECT=$PROJECT_ID",
        "-e", "SETTINGS_NAME=${_SETTINGS_NAME}",
        "--", "python", "/app/manage.py", "createcachetable",
      ]

  # Collect static files
  - id: "collect static files"
    name: "gcr.io/google-appengine/exec-wrapper"
    args:
      [
        "-i", "${_IMAGE_NAME}:$COMMIT_SHA",
        "-s", "${_CLOUDSQL_INSTANCE_CONNECTION_NAME}",
        "-e", "DJANGO_SETTINGS_MODULE=config.settings.production",
        "-e", "GOOGLE_CLOUD_PROJECT=$PROJECT_ID",
        "-e", "SETTINGS_NAME=${_SETTINGS_NAME}",
        "--", "python", "/app/manage.py", "collectstatic", "--noinput"
      ]

  # Compress static assets
  - id: "compress static assets"
    name: "gcr.io/google-appengine/exec-wrapper"
    args:
      [
        "-i", "${_IMAGE_NAME}:$COMMIT_SHA",
        "-s", "${_CLOUDSQL_INSTANCE_CONNECTION_NAME}",
        "-e", "DJANGO_SETTINGS_MODULE=config.settings.production",
        "-e", "GOOGLE_CLOUD_PROJECT=$PROJECT_ID",
        "-e", "SETTINGS_NAME=${_SETTINGS_NAME}",
        "--", "python", "/app/manage.py", "compress"
      ]

  # Get credentials for the cluster
  - id: "get credentials for the cluster"
    name: "gcr.io/cloud-builders/kubectl"
    env:
      - CLOUDSDK_CORE_PROJECT=$PROJECT_ID
      - CLOUDSDK_COMPUTE_ZONE=${_GKE_COMPUTE_ZONE}
      - CLOUDSDK_CONTAINER_CLUSTER=${_GKE_CLUSTER}
      - KUBECONFIG=/workspace/.kube/config
    args:
      - cluster-info

  # Show kubernetes manifest with values substituted
  - id: "show kubernetes manifest"
    dir: "deploy"
    name: "gcr.io/$PROJECT_ID/helm:3.7.0"
    env:
      - KUBECONFIG=/workspace/.kube/config
    args:
      - template
      - ${_APP_NAME}-${_DEPLOYMENT_TYPE}
      - --namespace=${_NAMESPACE}
      - --values
      - values.yaml
      - --set
      - namespace=${_NAMESPACE}
      - --set
      - django.image.repository=${_IMAGE_NAME}
      - --set
      - django.image.tag=$COMMIT_SHA
      - --set
      - ingress.networking.domain=${_DOMAIN_NAME}
      - --set
      - ingress.networking.issuer.name=${_LETSENCRYPT_SERVER_TYPE}
      - --set
      - ingress.networking.static_ip_name=${_STATIC_IP_NAME}
      - --set
      - pg_bouncer.env.db_name=${_PG_NAME}
      - --set
      - pg_bouncer.env.db_user=${_PG_USER}
      - --set
      - pg_bouncer.env.db_password=${_PG_PASSWORD}
      - --set
      - cloud_sql.env.cloudsql_connection_instance=${_CLOUDSQL_INSTANCE_CONNECTION_NAME}
      - --set
      - django.configmap.config_name=${_CONFIGMAP_FILE}
      - .

  # Update essential Variables and Deploy to cluster
  - id: "update essential variables and start deployment to cluster"
    dir: "deploy"
    name: "gcr.io/$PROJECT_ID/helm:3.7.0"
    env:
      - KUBECONFIG=/workspace/.kube/config
    args:
      - upgrade
      - --install
      - ${_APP_NAME}-${_DEPLOYMENT_TYPE}
      - --namespace=${_NAMESPACE}
      - --values
      - values.yaml
      - --set
      - namespace=${_NAMESPACE}
      - --set
      - django.image.repository=${_IMAGE_NAME}
      - --set
      - django.image.tag=$COMMIT_SHA
      - --set
      - ingress.networking.domain=${_DOMAIN_NAME}
      - --set
      - ingress.networking.issuer.name=${_LETSENCRYPT_SERVER_TYPE}
      - --set
      - ingress.networking.static_ip_name=${_STATIC_IP_NAME}
      - --set
      - pg_bouncer.env.db_name=${_PG_NAME}
      - --set
      - pg_bouncer.env.db_user=${_PG_USER}
      - --set
      - pg_bouncer.env.db_password=${_PG_PASSWORD}
      - --set
      - cloud_sql.env.cloudsql_connection_instance=${_CLOUDSQL_INSTANCE_CONNECTION_NAME}
      - --set
      - django.configmap.config_name=${_CONFIGMAP_FILE}
      - .

images:
  - "${_IMAGE_NAME}:$COMMIT_SHA"

timeout: 1200s
queueTtl: 3600s
